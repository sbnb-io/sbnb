#!/bin/sh
# Scan for available WiFi networks
# Usage: wifi-scan [INTERFACE]

# Find first wireless interface if none specified
find_wireless_iface() {
    for dev in /sys/class/net/*/wireless; do
        [ -d "$dev" ] && basename "$(dirname "$dev")" && return
    done
    echo ""
}

IFACE="${1:-$(find_wireless_iface)}"

# Check if interface was found/exists
if [ -z "$IFACE" ] || ! ip link show "$IFACE" >/dev/null 2>&1; then
    echo "Error: No wireless interface found"
    echo "Available wireless interfaces:"
    iw dev 2>/dev/null | grep Interface | awk '{print "  " $2}'
    exit 1
fi

# Bring interface up if down
ip link set "$IFACE" up 2>/dev/null || true

echo "Scanning for networks on $IFACE..."
echo ""

# Scan and parse per-BSS block for reliable results
iw dev "$IFACE" scan 2>/dev/null | awk '
/^BSS / {
    if (ssid != "" && ssid != "\\x00") printf "%-30s %s dBm  %s MHz\n", ssid, signal, freq
    ssid=""; signal=""; freq=""
}
/^\tfreq:/ { freq=$2 }
/^\tsignal:/ { signal=$2 }
/^\tSSID:/ { ssid=substr($0, index($0, ":")+2) }
END {
    if (ssid != "" && ssid != "\\x00") printf "%-30s %s dBm  %s MHz\n", ssid, signal, freq
}' | sort -t' ' -k2 -n

echo ""
echo "Use 'wifi-setup <SSID> <PASSWORD>' to connect"
