#!/bin/sh
# Scan for available WiFi networks
# Usage: wifi-scan [INTERFACE]

IFACE="${1:-wlan0}"

# Check if interface exists
if ! ip link show "$IFACE" >/dev/null 2>&1; then
    echo "Error: Interface $IFACE not found"
    echo "Available wireless interfaces:"
    iw dev 2>/dev/null | grep Interface | awk '{print "  " $2}'
    exit 1
fi

# Bring interface up if down
ip link set "$IFACE" up 2>/dev/null || true

echo "Scanning for networks on $IFACE..."
echo ""

# Scan and parse per-BSS block for reliable results
iw dev "$IFACE" scan 2>/dev/null | awk '
/^BSS / {
    if (ssid != "" && ssid != "\\x00") printf "%-30s %s dBm  %s MHz\n", ssid, signal, freq
    ssid=""; signal=""; freq=""
}
/^\tfreq:/ { freq=$2 }
/^\tsignal:/ { signal=$2 }
/^\tSSID:/ { ssid=substr($0, index($0, ":")+2) }
END {
    if (ssid != "" && ssid != "\\x00") printf "%-30s %s dBm  %s MHz\n", ssid, signal, freq
}' | sort -t' ' -k2 -n

echo ""
echo "Use 'wifi-setup <SSID> <PASSWORD>' to connect"
