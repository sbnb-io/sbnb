---
# Run OpenClaw CLI commands
#
# Usage:
#   export VM_HOST=sbnb-vm-67f97659333f
#
#   # List devices
#   ansible-playbook -i $VM_HOST, playbooks/openclaw-cli.yml -e "cmd='devices list'"
#
#   # Approve a device
#   ansible-playbook -i $VM_HOST, playbooks/openclaw-cli.yml -e "cmd='devices approve <request-id>'"
#
#   # Check status
#   ansible-playbook -i $VM_HOST, playbooks/openclaw-cli.yml -e "cmd='status'"
#
#   # Config with string value
#   ansible-playbook -i $VM_HOST, playbooks/openclaw-cli.yml \
#     -e "cmd='config set agents.defaults.model.primary ollama/qwen3:14b-q4_K_M'"
#
#   # Config with JSON value (use value parameter)
#   ansible-playbook -i $VM_HOST, playbooks/openclaw-cli.yml \
#     -e "cmd='config set models.providers.ollama'" \
#     -e 'value={"baseUrl":"http://ollama:11434/v1","apiKey":"ollama-local","api":"openai-responses"}'
#
#   # Any other command
#   ansible-playbook -i $VM_HOST, playbooks/openclaw-cli.yml -e "cmd='--help'"

- name: Run OpenClaw CLI command
  hosts: all
  become: true
  gather_facts: false

  vars:
    sbnb_openclaw_container_name: openclaw
    cmd: "--help"
    value: ""

  tasks:
    - name: Run OpenClaw CLI
      ansible.builtin.shell:
        cmd: >-
          docker exec {{ sbnb_openclaw_container_name }} node dist/index.js
          {{ cmd }}{{ ' ' + (value | to_json | quote) if value is mapping else (' ' + (value | string | quote) if value | string | length > 0 else '') }}
      register: cli_result
      changed_when: false
      failed_when: false

    - name: Display output
      vars:
        output_lines: "{{ cli_result.stdout_lines + cli_result.stderr_lines }}"
      ansible.builtin.debug:
        msg: "{{ output_lines }}"
