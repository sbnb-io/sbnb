---
# Example playbook to remove an SBNB VM
#
# Usage:
#   ansible-playbook sbnb.compute.remove-vm -i inventory/hosts.yml -e sbnb_vm_name=my-vm
#
# To also delete disk images:
#   ansible-playbook sbnb.compute.remove-vm -i inventory/hosts.yml -e sbnb_vm_name=my-vm -e sbnb_vm_persist_boot_image=false

- name: Remove SBNB VM
  hosts: "{{ target_hosts | default('all') }}"
  gather_facts: false

  collections:
    - sbnb.compute

  tasks:
    - name: Validate VM name is provided
      ansible.builtin.assert:
        that:
          - sbnb_vm_name is defined
        fail_msg: "sbnb_vm_name must be provided with -e sbnb_vm_name=..."

    - name: Remove VM
      sbnb.compute.qemu_vm:
        name: "{{ sbnb_vm_name }}"
        state: absent
        persist_boot_image: "{{ sbnb_vm_persist_boot_image | default(true) }}"
      register: vm_result

    - name: Display result
      ansible.builtin.debug:
        msg: "VM {{ sbnb_vm_name }} has been removed"
      when: vm_result.changed

    - name: Display skip message
      ansible.builtin.debug:
        msg: "VM {{ sbnb_vm_name }} was already absent"
      when: not vm_result.changed
